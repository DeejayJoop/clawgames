<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalog Avatar Creator Remix — Wardrobe Wizard</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0D1630;
      --panel:#0C1226CC;
      --panel2:#0D132BCC;
      --ink:#EAF1FF;
      --muted:#AFC3FF;
      --accent:#7CFFB2;
      --accent2:#7DB6FF;
      --warn:#FFD36E;
      --bad:#FF6B8B;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 10%, #1B2A66 0%, transparent 60%),
        radial-gradient(900px 650px at 90% 20%, #1C6B4A 0%, transparent 58%),
        radial-gradient(900px 700px at 60% 90%, #5B2A80 0%, transparent 60%),
        linear-gradient(160deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a.back{
      display:inline-flex;
      gap:.55rem;
      align-items:center;
      color:var(--ink);
      text-decoration:none;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      margin:14px;
    }
    a.back:hover{background:rgba(255,255,255,.09)}

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 24px;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin:8px 0 14px;
    }

    .hero{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:16px;
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 280px;
    }

    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:13px;line-height:1.35}
    .note{
      font-size:12px;
      color:rgba(234,241,255,.75);
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:12px;
      width:fit-content;
    }

    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:stretch;
      min-width: 320px;
      flex:1;
    }
    .card{
      border-radius: 16px;
      background: var(--panel);
      border:1px solid rgba(255,255,255,.12);
      padding:12px 12px 10px;
      box-shadow: 0 12px 25px rgba(0,0,0,.25);
      min-height: 64px;
    }
    .label{font-size:11px;color:rgba(234,241,255,.70);letter-spacing:.12em;text-transform:uppercase}
    .value{margin-top:6px;font-size:18px;font-weight:700}

    .meter{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      margin-top:8px;
    }
    .meter > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--accent2), var(--accent));
      transition: width .15s linear;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      margin-top:14px;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .stage{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-height: 540px;
      height: min(640px, 86vh);
    }

    canvas{
      width:100%;
      height:100%;
      display:block;
    }

    .controls{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      padding:14px;
      min-height: 540px;
      height: min(640px, 86vh);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius: 14px;
      background: var(--panel2);
      border:1px solid rgba(255,255,255,.10);
    }

    .slot{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1;
      min-width: 0;
    }
    .slot .name{font-weight:700}
    .slot .tags{font-size:12px;color:rgba(234,241,255,.72);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .btns{display:flex;gap:8px}

    button{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:700;
      color: var(--ink);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      transition: transform .04s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.11)}
    button:active{transform: translateY(1px)}
    button.primary{
      background: linear-gradient(90deg, rgba(125,182,255,.24), rgba(124,255,178,.22));
      border-color: rgba(124,255,178,.30);
    }
    button.warn{
      background: linear-gradient(90deg, rgba(255,211,110,.22), rgba(255,107,139,.18));
      border-color: rgba(255,211,110,.35);
    }

    .bigActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:12px;
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
    }

    .promptBox{
      padding:12px;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .promptTitle{font-weight:800;letter-spacing:.2px}
    .req{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;
      color:rgba(234,241,255,.90);
    }
    .chip.good{border-color: rgba(124,255,178,.35); background: rgba(124,255,178,.12)}
    .chip.bad{border-color: rgba(255,107,139,.35); background: rgba(255,107,139,.12)}

    .log{
      flex: 0 0 180px;
      max-height: 200px;
      min-height: 160px;
      padding:12px;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      overflow:auto;
      font-size:13px;
      line-height:1.45;
      color:rgba(234,241,255,.85);
    }
    .log b{color:var(--ink)}

    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: radial-gradient(800px 500px at 50% 30%, rgba(0,0,0,.55), rgba(0,0,0,.82));
    }
    .overlay.show{display:flex}

    .modal{
      max-width: 720px;
      width:100%;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      padding:18px;
    }

    .modal h2{margin:0 0 8px;font-size:22px}
    .modal p{margin:8px 0;color:rgba(234,241,255,.82);line-height:1.5}

    /* Visual goal example (no text): brief tags → outfit tags → score */
    .goalViz{
      margin-top:10px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;
    }
    .goalViz svg{width:100%;height:auto;display:block}

    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding:2px 8px; border-radius: 999px; background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.12)}

    .modal .cols{display:grid;grid-template-columns:1.15fr .85fr;gap:12px;margin-top:12px}
    @media (max-width: 860px){
      .modal .cols{grid-template-columns:1fr}
    }

    .how{
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
      font-size:13px;
      line-height:1.45;
      color:rgba(234,241,255,.85);
    }

    .credits{
      margin-top:10px;
      font-size:12px;
      color:rgba(234,241,255,.70);
    }

    .pillRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}

    .sr{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <a class="back" href="./index.html" aria-label="Back to Claw Games">← Back to Claw Games</a>

  <div class="wrap">
    <header>
      <div class="hero">
        <div class="title">
          <h1>Wardrobe Wizard</h1>
          <div class="sub">Build an outfit to match a style brief. Earn flair points for matching tags. Miss too many tags and you bomb the photoshoot.</div>
          <div class="note">Inspired by <b>Catalog Avatar Creator</b> (remix)</div>
        </div>

        <div class="hud" aria-label="HUD">
          <div class="card">
            <div class="label">Round</div>
            <div class="value"><span id="roundNum">0</span> / <span id="roundTotal">5</span></div>
          </div>
          <div class="card">
            <div class="label">Score</div>
            <div class="value" id="score">0</div>
          </div>
          <div class="card">
            <div class="label">Time</div>
            <div class="value"><span id="time">0.0</span>s</div>
            <div class="meter" aria-hidden="true"><div id="timeBar"></div></div>
          </div>
        </div>
      </div>
    </header>

    <main class="grid">
      <section class="stage" aria-label="Avatar Stage">
        <canvas id="c" width="840" height="780"></canvas>
        <div class="overlay show" id="overlay">
          <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <h2 id="modalTitle">Wardrobe Wizard</h2>
            <p>
              You are the stylist. Every round gives you a <b>style brief</b> (tags). Pick one item per slot to match.
              Click <b>Submit Outfit</b> before time runs out.
            </p>

            <!-- Visual goal example (no explanatory text) -->
            <div class="goalViz" aria-hidden="true">
              <svg viewBox="0 0 680 128" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="gv_bg" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="#7DB6FF" stop-opacity="0.20"/>
                    <stop offset="1" stop-color="#7CFFB2" stop-opacity="0.18"/>
                  </linearGradient>
                  <filter id="gv_glow" x="-40%" y="-60%" width="180%" height="220%">
                    <feGaussianBlur stdDeviation="6" result="b"/>
                    <feColorMatrix in="b" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.55 0" result="g"/>
                    <feMerge>
                      <feMergeNode in="g"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>

                <rect x="0" y="0" width="680" height="128" rx="18" fill="url(#gv_bg)"/>
                <rect x="0" y="0" width="680" height="128" rx="18" fill="rgba(0,0,0,0.18)"/>

                <!-- Left: brief chips (icons only) -->
                <g transform="translate(18,18)">
                  <rect x="0" y="0" width="190" height="92" rx="16" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.12)"/>
                  <g transform="translate(16,16)">
                    <rect x="0" y="0" width="74" height="26" rx="13" fill="rgba(125,182,255,0.22)" stroke="rgba(125,182,255,0.45)"/>
                    <circle cx="14" cy="13" r="6" fill="rgba(234,241,255,0.85)"/>
                    <rect x="84" y="0" width="74" height="26" rx="13" fill="rgba(124,255,178,0.18)" stroke="rgba(124,255,178,0.42)"/>
                    <path d="M99 14 l6 6 l10-14" fill="none" stroke="rgba(234,241,255,0.85)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="0" y="34" width="74" height="26" rx="13" fill="rgba(255,211,110,0.16)" stroke="rgba(255,211,110,0.42)"/>
                    <path d="M16 39 l4 8 l10-14" fill="none" stroke="rgba(234,241,255,0.80)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="84" y="34" width="74" height="26" rx="13" fill="rgba(255,107,139,0.14)" stroke="rgba(255,107,139,0.38)"/>
                    <path d="M102 42 l12 12 M114 42 l-12 12" stroke="rgba(234,241,255,0.80)" stroke-width="3" stroke-linecap="round"/>
                  </g>
                </g>

                <!-- Middle: mannequin + tags -->
                <g transform="translate(260,10)" filter="url(#gv_glow)">
                  <path d="M70 25c0-10 8-18 18-18s18 8 18 18-8 18-18 18-18-8-18-18z" fill="rgba(234,241,255,0.18)" stroke="rgba(255,255,255,0.16)"/>
                  <path d="M88 43c-12 0-22 10-22 22v10c0 7 6 13 13 13h18c7 0 13-6 13-13V65c0-12-10-22-22-22z" fill="rgba(234,241,255,0.12)" stroke="rgba(255,255,255,0.14)"/>
                  <path d="M64 62c-10 6-16 17-16 28v18c0 6 5 11 11 11h6" fill="none" stroke="rgba(234,241,255,0.16)" stroke-width="10" stroke-linecap="round"/>
                  <path d="M112 62c10 6 16 17 16 28v18c0 6-5 11-11 11h-6" fill="none" stroke="rgba(234,241,255,0.16)" stroke-width="10" stroke-linecap="round"/>
                  <path d="M78 90v26c0 8 6 14 14 14s14-6 14-14V90" fill="none" stroke="rgba(234,241,255,0.14)" stroke-width="12" stroke-linecap="round"/>
                </g>

                <!-- Right: outcome icons -->
                <g transform="translate(482,18)">
                  <rect x="0" y="0" width="180" height="92" rx="16" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.12)"/>
                  <g transform="translate(20,22)">
                    <circle cx="16" cy="16" r="14" fill="rgba(124,255,178,0.18)" stroke="rgba(124,255,178,0.45)"/>
                    <path d="M10 16 l5 6 l10-14" fill="none" stroke="rgba(234,241,255,0.86)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>

                    <circle cx="72" cy="16" r="14" fill="rgba(255,107,139,0.14)" stroke="rgba(255,107,139,0.40)"/>
                    <path d="M64 8 l16 16 M80 8 l-16 16" stroke="rgba(234,241,255,0.82)" stroke-width="3" stroke-linecap="round"/>

                    <circle cx="128" cy="16" r="14" fill="rgba(255,211,110,0.16)" stroke="rgba(255,211,110,0.42)"/>
                    <path d="M128 6 l4 10 l10 1 l-8 6 l3 10 l-9-6 l-9 6 l3-10 l-8-6 l10-1z" fill="rgba(234,241,255,0.82)"/>

                    <rect x="2" y="46" width="156" height="14" rx="7" fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.10)"/>
                    <rect x="2" y="46" width="118" height="14" rx="7" fill="rgba(125,182,255,0.18)"/>
                  </g>
                </g>

                <!-- Arrows -->
                <g opacity="0.65" stroke="rgba(234,241,255,0.55)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M226 64h18l-8-8m8 8l-8 8"/>
                  <path d="M444 64h18l-8-8m8 8l-8 8"/>
                </g>
              </svg>
            </div>

            <div class="cols">
              <div class="how">
                <div><b>How scoring works</b></div>
                <ul style="margin:8px 0 0; padding-left:18px">
                  <li>Each round: match as many required tags as you can.</li>
                  <li>+25 points per matched tag.</li>
                  <li>+10 bonus if you match <i>all</i> tags.</li>
                  <li>+1 flair point for each unique extra tag in your outfit.</li>
                  <li>Lose instantly if you submit with <b>2 or more missing</b> required tags.</li>
                </ul>
                <p style="margin:10px 0 0">
                  Controls: use the <span class="kbd">◀</span> and <span class="kbd">▶</span> buttons or press
                  <span class="kbd">A</span>/<span class="kbd">D</span> to cycle a slot.
                </p>
              </div>
              <div class="how">
                <div><b>Win / Lose</b></div>
                <ul style="margin:8px 0 0; padding-left:18px">
                  <li>Win by finishing all rounds with a total score of <b id="targetScore">220</b>+.</li>
                  <li>Lose if time hits 0, or you miss too many tags.</li>
                </ul>
                <div class="pillRow" aria-label="Tips">
                  <span class="chip">Look for color tags</span>
                  <span class="chip">Some items have 3 tags</span>
                  <span class="chip">Extra flair adds points</span>
                </div>
              </div>
            </div>
            <div class="bigActions" style="margin-top:12px">
              <button class="primary" id="startBtn">Start</button>
              <button id="practiceBtn">Practice Round</button>
              <button class="warn" id="muteBtn" aria-pressed="false">Sound: On</button>
            </div>
            <div class="credits">Single-file microgame. No external assets.</div>
          </div>
        </div>
      </section>

      <section class="controls" aria-label="Controls">
        <div class="promptBox">
          <div class="promptTitle">Goal outfit</div>
          <div class="sub" style="margin-top:6px">Match the colors & vibe shown (no text hints).</div>
          <canvas id="goalCanvas" width="360" height="280" style="width:100%;height:auto;display:block;margin-top:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12)"></canvas>
        </div>

        <div class="row" data-slot="hair">
          <div class="slot">
            <div class="name">Hair</div>
            <div class="tags" id="hairDesc">—</div>
          </div>
          <div class="btns">
            <button data-action="prev" aria-label="Previous hair">◀</button>
            <button data-action="next" aria-label="Next hair">▶</button>
          </div>
        </div>

        <div class="row" data-slot="top">
          <div class="slot">
            <div class="name">Top</div>
            <div class="tags" id="topDesc">—</div>
          </div>
          <div class="btns">
            <button data-action="prev" aria-label="Previous top">◀</button>
            <button data-action="next" aria-label="Next top">▶</button>
          </div>
        </div>

        <div class="row" data-slot="bottom">
          <div class="slot">
            <div class="name">Bottom</div>
            <div class="tags" id="bottomDesc">—</div>
          </div>
          <div class="btns">
            <button data-action="prev" aria-label="Previous bottom">◀</button>
            <button data-action="next" aria-label="Next bottom">▶</button>
          </div>
        </div>

        <div class="row" data-slot="shoes">
          <div class="slot">
            <div class="name">Shoes</div>
            <div class="tags" id="shoesDesc">—</div>
          </div>
          <div class="btns">
            <button data-action="prev" aria-label="Previous shoes">◀</button>
            <button data-action="next" aria-label="Next shoes">▶</button>
          </div>
        </div>

        <div class="row" data-slot="accessory">
          <div class="slot">
            <div class="name">Accessory</div>
            <div class="tags" id="accessoryDesc">—</div>
          </div>
          <div class="btns">
            <button data-action="prev" aria-label="Previous accessory">◀</button>
            <button data-action="next" aria-label="Next accessory">▶</button>
          </div>
        </div>

        <div class="bigActions">
          <button class="primary" id="submitBtn">Submit Outfit</button>
          <button id="shuffleBtn" title="Randomize outfit">Randomize</button>
          <button class="warn" id="restartBtn">Restart Run</button>
        </div>

        <div class="log" id="log" aria-label="Run log"></div>
      </section>
    </main>
  </div>

<script>
(() => {
  "use strict";

  // -------------------------
  // Tiny audio (no external assets)
  // -------------------------
  const AudioSys = (() => {
    let ctx = null;
    let enabled = true;

    function ensure(){
      if(!ctx){
        ctx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if(ctx.state === 'suspended') ctx.resume().catch(()=>{});
    }

    function tone(freq, dur=0.08, type='sine', vol=0.06){
      if(!enabled) return;
      ensure();
      const t0 = ctx.currentTime;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(vol, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      o.connect(g).connect(ctx.destination);
      o.start(t0);
      o.stop(t0 + dur + 0.02);
    }

    function chord(kind){
      if(kind === 'good'){
        tone(660, 0.07, 'triangle', 0.07);
        setTimeout(()=>tone(880, 0.08, 'triangle', 0.06), 60);
      } else if(kind === 'bad'){
        tone(220, 0.10, 'sawtooth', 0.05);
        setTimeout(()=>tone(185, 0.12, 'sawtooth', 0.05), 70);
      } else if(kind === 'tick'){
        tone(880, 0.03, 'square', 0.03);
      } else if(kind === 'start'){
        tone(440, 0.06, 'triangle', 0.05);
        setTimeout(()=>tone(554, 0.06, 'triangle', 0.05), 70);
        setTimeout(()=>tone(659, 0.07, 'triangle', 0.05), 140);
      }
    }

    return {
      setEnabled(v){ enabled = !!v; },
      isEnabled(){ return enabled; },
      poke(){ if(enabled) ensure(); },
      tone, chord
    };
  })();

  // -------------------------
  // Data model
  // -------------------------
  const slots = ["hair","top","bottom","shoes","accessory"];

  const ITEMS = {
    hair: [
      { name:"Nebula Bob", color:"#7DB6FF", tags:["neon","space","cool"] },
      { name:"Cozy Waves", color:"#FFD36E", tags:["cozy","warm","casual"] },
      { name:"Shadow Spikes", color:"#B7B9C9", tags:["stealth","edgy","cool"] },
      { name:"Garden Braids", color:"#7CFFB2", tags:["nature","cute","fresh"] },
      { name:"Retro Puff", color:"#FF6B8B", tags:["retro","bold","cute"] },
      { name:"Pixel Fringe", color:"#B0FF7D", tags:["pixel","tech","playful"] },
    ],
    top: [
      { name:"Arcade Hoodie", color:"#B0FF7D", tags:["pixel","casual","tech"] },
      { name:"Starlight Jacket", color:"#7DB6FF", tags:["space","cool","bold"] },
      { name:"Cafe Cardigan", color:"#FFD36E", tags:["cozy","warm","soft"] },
      { name:"Ninja Wrap", color:"#B7B9C9", tags:["stealth","edgy","cool"] },
      { name:"Meadow Tee", color:"#7CFFB2", tags:["nature","fresh","casual"] },
      { name:"Pop Star Blazer", color:"#FF6B8B", tags:["bold","retro","sparkle"] },
    ],
    bottom: [
      { name:"Neon Skirt", color:"#7DB6FF", tags:["neon","bold","sparkle"] },
      { name:"Trail Shorts", color:"#7CFFB2", tags:["nature","fresh","casual"] },
      { name:"Comfy Pants", color:"#FFD36E", tags:["cozy","warm","soft"] },
      { name:"Stealth Joggers", color:"#B7B9C9", tags:["stealth","tech","cool"] },
      { name:"Retro Jeans", color:"#FF6B8B", tags:["retro","playful","casual"] },
      { name:"Orbit Leggings", color:"#7DB6FF", tags:["space","tech","cool"] },
    ],
    shoes: [
      { name:"Hover Kicks", color:"#7DB6FF", tags:["tech","neon","cool"] },
      { name:"Forest Boots", color:"#7CFFB2", tags:["nature","fresh","sturdy"] },
      { name:"Cafe Slippers", color:"#FFD36E", tags:["cozy","soft","warm"] },
      { name:"Shadow Sneakers", color:"#B7B9C9", tags:["stealth","edgy","cool"] },
      { name:"Retro Runners", color:"#FF6B8B", tags:["retro","bold","playful"] },
      { name:"Star Sandals", color:"#7DB6FF", tags:["space","sparkle","cute"] },
    ],
    accessory: [
      { name:"Holo Visor", color:"#7DB6FF", tags:["tech","neon","bold"] },
      { name:"Leaf Pin", color:"#7CFFB2", tags:["nature","cute","fresh"] },
      { name:"Warm Scarf", color:"#FFD36E", tags:["cozy","warm","soft"] },
      { name:"Smoke Mask", color:"#B7B9C9", tags:["stealth","edgy","cool"] },
      { name:"Disco Star", color:"#FF6B8B", tags:["retro","sparkle","bold"] },
      { name:"Pixel Pet", color:"#B0FF7D", tags:["pixel","playful","cute"] },
    ]
  };

  // briefs: 2-4 tags + a short sentence
  const BRIEFS = [
    { name:"Neon Ninja", text:"A secret agent with flashy street tech.", tags:["neon","stealth","tech"] },
    { name:"Cozy Cafe", text:"Soft, warm, and ready for a rainy window seat.", tags:["cozy","warm","soft"] },
    { name:"Galactic Cool", text:"Space vibes, clean lines, and confidence.", tags:["space","cool"] },
    { name:"Forest Fresh", text:"Nature energy with an outdoorsy twist.", tags:["nature","fresh"] },
    { name:"Retro Pop", text:"Bold throwback with sparkle potential.", tags:["retro","bold"] },
    { name:"Pixel Party", text:"Arcade aesthetic—playful and techy.", tags:["pixel","playful","tech"] },
    { name:"Edgy Shadow", text:"Dark, sharp, and not here to chat.", tags:["edgy","stealth","cool"] },
    { name:"Cute Sparkle", text:"Adorable, shiny, and camera-ready.", tags:["cute","sparkle"] },
    { name:"Warm Wanderer", text:"Comfy fit with sturdy choices.", tags:["warm","casual","sturdy"] },
    { name:"Tech Idol", text:"A performer with futuristic accessories.", tags:["tech","bold","sparkle"] },
  ];

  // -------------------------
  // DOM
  // -------------------------
  const els = {
    c: document.getElementById('c'),
    overlay: document.getElementById('overlay'),
    startBtn: document.getElementById('startBtn'),
    practiceBtn: document.getElementById('practiceBtn'),
    muteBtn: document.getElementById('muteBtn'),

    roundNum: document.getElementById('roundNum'),
    roundTotal: document.getElementById('roundTotal'),
    score: document.getElementById('score'),
    time: document.getElementById('time'),
    timeBar: document.getElementById('timeBar'),

    goalCanvas: document.getElementById('goalCanvas'),

    submitBtn: document.getElementById('submitBtn'),
    shuffleBtn: document.getElementById('shuffleBtn'),
    restartBtn: document.getElementById('restartBtn'),

    log: document.getElementById('log'),

    targetScore: document.getElementById('targetScore'),

    desc: {
      hair: document.getElementById('hairDesc'),
      top: document.getElementById('topDesc'),
      bottom: document.getElementById('bottomDesc'),
      shoes: document.getElementById('shoesDesc'),
      accessory: document.getElementById('accessoryDesc')
    }
  };

  const ctx2d = els.c.getContext('2d');

  // -------------------------
  // Game state
  // -------------------------
  const STATE = {
    running: false,
    practice: false,
    round: 0,
    roundsTotal: 5,
    score: 0,
    target: 220,
    t: 0,
    tMax: 26.0,
    brief: null,
    goalSel: { hair:0, top:0, bottom:0, shoes:0, accessory:0 },
    // selection indices per slot
    sel: {
      hair: 0,
      top: 0,
      bottom: 0,
      shoes: 0,
      accessory: 0,
    },
    lastTickBeep: 999,
    // particles for feedback
    pops: []
  };

  function clamp(v,a,b){return Math.max(a, Math.min(b,v));}

  function rand(n){return Math.floor(Math.random()*n);}

  function choice(arr){return arr[rand(arr.length)];}

  function uniq(arr){return Array.from(new Set(arr));}

  function outfitItems(){
    return slots.map(s => ITEMS[s][STATE.sel[s]]);
  }

  function outfitTags(){
    return uniq(outfitItems().flatMap(it => it.tags));
  }

  function setLog(html){
    els.log.innerHTML = html;
    els.log.scrollTop = els.log.scrollHeight;
  }

  function addLog(line){
    const d = document.createElement('div');
    d.innerHTML = line;
    els.log.appendChild(d);
    els.log.scrollTop = els.log.scrollHeight;
  }

  function describeSlot(slot){
    const it = ITEMS[slot][STATE.sel[slot]];
    return `<b>${it.name}</b> — tags: ${it.tags.join(', ')}`;
  }

  function refreshSlotDescs(){
    for(const s of slots){
      const it = ITEMS[s][STATE.sel[s]];
      els.desc[s].textContent = `${it.name} — ${it.tags.join(', ')}`;
    }
  }

  function refreshHud(){
    els.roundNum.textContent = String(STATE.round);
    els.roundTotal.textContent = String(STATE.roundsTotal);
    els.score.textContent = String(STATE.score);
    els.targetScore.textContent = String(STATE.target);
    els.time.textContent = STATE.running ? STATE.t.toFixed(1) : (STATE.tMax).toFixed(1);
    const pct = STATE.running ? (STATE.t / STATE.tMax) : 1;
    els.timeBar.style.width = `${(pct*100).toFixed(2)}%`;
  }

  function renderReqChips(){
    // Intentionally disabled: the goal is shown as a visual target outfit (not text chips).
    return;
  }

  function setBrief(brief){
    STATE.brief = brief;
    pickGoalForBrief(brief);
    drawGoalPreview();
  }

  function shuffleOutfit(){
    for(const s of slots){
      STATE.sel[s] = rand(ITEMS[s].length);
    }
    refreshSlotDescs();
    pop("shuffle");
  }

  function cycle(slot, dir){
    const n = ITEMS[slot].length;
    const i = STATE.sel[slot];
    STATE.sel[slot] = (i + dir + n) % n;
    refreshSlotDescs();
    pop(slot);
    AudioSys.tone(dir>0 ? 520 : 460, 0.045, 'triangle', 0.04);
  }

  function pop(where){
    // spawn a few particles near the slot area
    const map = {
      hair:[420, 190],
      top:[420, 340],
      bottom:[420, 470],
      shoes:[420, 600],
      accessory:[620, 260],
      shuffle:[560, 520]
    };
    const p = map[where] || [420, 380];
    const it = where in STATE.sel ? ITEMS[where][STATE.sel[where]] : null;
    const col = it ? it.color : '#FFFFFF';
    for(let k=0;k<10;k++){
      STATE.pops.push({
        x:p[0] + (Math.random()*24-12),
        y:p[1] + (Math.random()*24-12),
        vx:(Math.random()*2-1)*3.2,
        vy:(Math.random()*2-1)*3.2,
        life: 0.7 + Math.random()*0.35,
        t: 0,
        col
      });
    }
  }

  function startRun({practice=false}={}){
    AudioSys.poke();
    STATE.practice = practice;
    STATE.running = true;
    STATE.round = 1;
    STATE.score = 0;
    STATE.lastTickBeep = 999;
    STATE.roundsTotal = practice ? 1 : 5;
    STATE.target = practice ? 0 : 220;
    STATE.tMax = practice ? 999 : 26.0;
    STATE.t = STATE.tMax;

    shuffleOutfit();
    // pick a brief that isn't too strict early on
    const b = choice(BRIEFS);
    setBrief(b);

    setLog('');
    addLog(`<b>Run started.</b> Brief: <b>${b.name}</b> — required tags: <b>${b.tags.join(', ')}</b>.`);
    if(practice){
      addLog(`Practice mode: no timer, no target score. Submit to see scoring.`);
    } else {
      addLog(`You have <b>${STATE.tMax.toFixed(0)} seconds</b>. Miss <b>2+</b> required tags and you lose.`);
    }

    els.overlay.classList.remove('show');
    AudioSys.chord('start');
    refreshHud();
  }

  function endRun({win, reason}){
    STATE.running = false;
    refreshHud();

    const title = win ? 'You Win!' : 'Run Over';
    const msg = win
      ? `You cleared ${STATE.roundsTotal} rounds with <b>${STATE.score}</b> points.`
      : `Reason: <b>${reason}</b>. Final score: <b>${STATE.score}</b>.`;

    document.getElementById('modalTitle').textContent = title;

    const modal = els.overlay.querySelector('.modal');
    // rewrite modal body but keep buttons
    const buttons = modal.querySelector('.bigActions');
    const credits = modal.querySelector('.credits');
    const cols = modal.querySelector('.cols');

    // remove existing explanatory paragraphs (keep title only)
    [...modal.querySelectorAll('p')].forEach(p => p.remove());

    const p1 = document.createElement('p');
    p1.innerHTML = msg;
    const p2 = document.createElement('p');
    p2.innerHTML = `Tip: chase required tags first, then collect extra flair tags for +1 each.`;
    modal.insertBefore(p1, cols);
    modal.insertBefore(p2, cols);

    // update buttons text
    els.startBtn.textContent = 'Play Again';
    els.practiceBtn.textContent = 'Practice';

    els.overlay.classList.add('show');

    if(win) AudioSys.chord('good');
    else AudioSys.chord('bad');
  }

  function nextRound(){
    STATE.round++;
    if(STATE.round > STATE.roundsTotal){
      const win = STATE.practice ? true : (STATE.score >= STATE.target);
      endRun({win, reason: win ? 'Target met' : `Need ${STATE.target}+ points`});
      return;
    }

    STATE.t = STATE.tMax;
    STATE.lastTickBeep = 999;

    // pick a new brief different from previous
    let b = choice(BRIEFS);
    for(let tries=0; tries<8 && STATE.brief && b.name === STATE.brief.name; tries++){
      b = choice(BRIEFS);
    }
    setBrief(b);

    // small reshuffle for variety (but keep player choice momentum)
    if(Math.random() < 0.35) shuffleOutfit();

    addLog(`<hr style="border:none;border-top:1px solid rgba(255,255,255,.12);margin:10px 0">`);
    addLog(`<b>Round ${STATE.round}/${STATE.roundsTotal}.</b> New target loaded: <b>${b.name}</b>.`);

    AudioSys.tone(740, 0.05, 'triangle', 0.05);
    refreshHud();
  }

  function submitOutfit(){
    if(!STATE.brief){
      addLog('No brief yet.');
      return;
    }

    const tags = outfitTags();
    const have = new Set(tags);
    const req = STATE.brief.tags;

    const matched = req.filter(t => have.has(t));
    const missing = req.filter(t => !have.has(t));

    // flair: unique tags that are NOT required
    const flairTags = tags.filter(t => !req.includes(t));

    const base = matched.length * 25;
    const allBonus = (missing.length === 0) ? 10 : 0;
    const flair = flairTags.length;

    const roundPts = base + allBonus + flair;

    // lose conditions
    if(!STATE.practice){
      if(missing.length >= 2){
        addLog(`<b style="color: var(--bad)">Submission failed.</b> Missing: <b>${missing.join(', ')}</b>.`);
        addLog(`You missed <b>${missing.length}</b> required tags (2+ is an instant loss).`);
        endRun({win:false, reason:`Missed ${missing.length} required tags`});
        return;
      }

      // time check (if player somehow submits at exactly zero)
      if(STATE.t <= 0){
        endRun({win:false, reason:"Time ran out"});
        return;
      }
    }

    STATE.score += roundPts;

    // feedback log
    const mLine = matched.length ? `<span style="color: var(--accent)"><b>Matched</b></span>: ${matched.join(', ')}` : `<span style="color: var(--bad)"><b>Matched</b></span>: none`;
    const missLine = missing.length ? `<span style="color: var(--warn)"><b>Missing</b></span>: ${missing.join(', ')}` : `<span style="color: var(--accent)"><b>Missing</b></span>: none`;

    addLog(`<b>Submitted:</b> +<b>${roundPts}</b> points (${matched.length}×25${allBonus?` +${allBonus} perfect`:''} +${flair} flair).`);
    addLog(`${mLine}<br>${missLine}`);

    if(missing.length === 0) AudioSys.chord('good');
    else AudioSys.tone(520, 0.06, 'triangle', 0.05);

    pop('shuffle');
    refreshHud();

    if(STATE.practice){
      addLog(`<i>Practice complete.</i> Change items and submit again, or Play Again.`);
      return;
    }

    nextRound();
  }

  

  // -------------------------
  // Goal outfit (visual target)
  // -------------------------
  function pickGoalForBrief(brief){
    // Pick items that match the brief tags best (ties random).
    for (const slot of slots){
      const items = ITEMS[slot];
      let best = -1;
      let bestIdxs = [];
      for (let i=0;i<items.length;i++){
        const it = items[i];
        const overlap = it.tags.filter(t => brief.tags.includes(t)).length;
        if (overlap > best){
          best = overlap;
          bestIdxs = [i];
        } else if (overlap === best){
          bestIdxs.push(i);
        }
      }
      STATE.goalSel[slot] = bestIdxs[Math.floor(Math.random()*bestIdxs.length)];
    }
  }

  function drawGoalPreview(){
    const gc = els.goalCanvas;
    if (!gc) return;
    const g = gc.getContext('2d');
    const Wg = gc.width, Hg = gc.height;
    g.clearRect(0,0,Wg,Hg);

    const bg = g.createRadialGradient(Wg*0.5,Hg*0.35, 10, Wg*0.5,Hg*0.6, Math.max(Wg,Hg)*0.75);
    bg.addColorStop(0,'rgba(125,182,255,0.18)');
    bg.addColorStop(0.55,'rgba(124,255,178,0.10)');
    bg.addColorStop(1,'rgba(0,0,0,0)');
    g.fillStyle = bg;
    g.fillRect(0,0,Wg,Hg);

    // Reuse stage mannequin drawing by translating a virtual 840x780 stage into this small canvas.
    g.save();
    g.translate(-170, -120);
    drawMannequin(g, 840, 780);
    drawItemLayer(g, 'hair', ITEMS.hair[STATE.goalSel.hair]);
    drawItemLayer(g, 'top', ITEMS.top[STATE.goalSel.top]);
    drawItemLayer(g, 'bottom', ITEMS.bottom[STATE.goalSel.bottom]);
    drawItemLayer(g, 'shoes', ITEMS.shoes[STATE.goalSel.shoes]);
    drawItemLayer(g, 'accessory', ITEMS.accessory[STATE.goalSel.accessory]);
    g.restore();

    g.save();
    g.strokeStyle = 'rgba(255,255,255,0.14)';
    g.lineWidth = 2;
    g.strokeRect(10, 10, Wg-20, Hg-20);
    g.fillStyle = 'rgba(234,241,255,0.72)';
    g.font = '700 12px ui-sans-serif, system-ui';
    g.fillText('TARGET', 14, 24);
    g.restore();
  }
// -------------------------
  // Canvas rendering
  // -------------------------
  function roundRect(g, x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    g.beginPath();
    g.moveTo(x+r,y);
    g.arcTo(x+w,y, x+w,y+h, r);
    g.arcTo(x+w,y+h, x,y+h, r);
    g.arcTo(x,y+h, x,y, r);
    g.arcTo(x,y, x+w,y, r);
    g.closePath();
  }

  function drawBackdrop(g, W, H){
    // tiled soft glows
    g.save();
    g.fillStyle = 'rgba(0,0,0,0)';
    g.clearRect(0,0,W,H);

    const grad = g.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, 'rgba(255,255,255,0.06)');
    grad.addColorStop(1, 'rgba(0,0,0,0.00)');
    g.fillStyle = grad;
    g.fillRect(0,0,W,H);

    // stage frame
    roundRect(g, 26, 26, W-52, H-52, 26);
    g.fillStyle = 'rgba(10,16,38,0.55)';
    g.fill();
    g.strokeStyle = 'rgba(255,255,255,0.14)';
    g.lineWidth = 2;
    g.stroke();

    // spotlights
    for(let i=0;i<3;i++){
      const x = 140 + i*240;
      const y = 30;
      const r = 260;
      const gg = g.createRadialGradient(x,y, 10, x,y, r);
      gg.addColorStop(0, 'rgba(125,182,255,0.20)');
      gg.addColorStop(0.55, 'rgba(124,255,178,0.08)');
      gg.addColorStop(1, 'rgba(0,0,0,0)');
      g.fillStyle = gg;
      g.beginPath();
      g.arc(x,y, r, 0, Math.PI*2);
      g.fill();
    }

    // floor
    const floor = g.createLinearGradient(0,H-220, 0,H);
    floor.addColorStop(0, 'rgba(255,255,255,0.00)');
    floor.addColorStop(1, 'rgba(255,255,255,0.05)');
    g.fillStyle = floor;
    g.fillRect(52, H-220, W-104, 180);

    g.restore();
  }

  function drawMannequin(g, W, H){
    // A nicer, more human silhouette (still stylized / “Roblox-ish”)
    const cx = 300;
    const topY = 140;

    g.save();

    // ground shadow
    g.fillStyle = 'rgba(0,0,0,0.35)';
    g.beginPath();
    g.ellipse(cx, H-135, 155, 38, 0, 0, Math.PI*2);
    g.fill();

    // subtle body gradient
    const bodyGrad = g.createLinearGradient(cx-120, topY-10, cx+120, topY+620);
    bodyGrad.addColorStop(0, 'rgba(255,255,255,0.18)');
    bodyGrad.addColorStop(0.55, 'rgba(255,255,255,0.10)');
    bodyGrad.addColorStop(1, 'rgba(255,255,255,0.06)');

    const outline = 'rgba(255,255,255,0.14)';

    // head
    {
      const headGrad = g.createRadialGradient(cx-16, topY-10, 6, cx, topY+6, 74);
      headGrad.addColorStop(0, 'rgba(255,255,255,0.22)');
      headGrad.addColorStop(1, 'rgba(255,255,255,0.10)');
      g.fillStyle = headGrad;
      g.beginPath();
      g.ellipse(cx, topY, 54, 60, 0, 0, Math.PI*2);
      g.fill();
      g.strokeStyle = 'rgba(255,255,255,0.18)';
      g.lineWidth = 2;
      g.stroke();

      // tiny face notch (just to feel less like an egg)
      g.strokeStyle = 'rgba(0,0,0,0.10)';
      g.lineWidth = 3;
      g.beginPath();
      g.arc(cx+10, topY+10, 16, -0.15*Math.PI, 0.55*Math.PI);
      g.stroke();
    }

    // neck
    {
      g.fillStyle = 'rgba(255,255,255,0.10)';
      roundRect(g, cx-16, topY+52, 32, 26, 12);
      g.fill();
      g.strokeStyle = outline;
      g.lineWidth = 2;
      g.stroke();
    }

    // torso + hips as one smooth path
    {
      g.fillStyle = bodyGrad;
      g.strokeStyle = outline;
      g.lineWidth = 2;

      const y0 = topY + 76;
      g.beginPath();
      g.moveTo(cx-92, y0+44);
      // left shoulder → waist
      g.bezierCurveTo(cx-128, y0+60, cx-126, y0+132, cx-92, y0+166);
      // left waist → left hip
      g.bezierCurveTo(cx-76, y0+188, cx-78, y0+222, cx-102, y0+250);
      // bottom of hips
      g.bezierCurveTo(cx-126, y0+282, cx-96, y0+320, cx-62, y0+330);
      // inner left hip
      g.bezierCurveTo(cx-34, y0+338, cx-22, y0+318, cx-18, y0+300);
      // inner right hip
      g.bezierCurveTo(cx-8, y0+258, cx+8, y0+258, cx+18, y0+300);
      g.bezierCurveTo(cx+22, y0+318, cx+34, y0+338, cx+62, y0+330);
      // right hip bottom
      g.bezierCurveTo(cx+96, y0+320, cx+126, y0+282, cx+102, y0+250);
      // right hip → waist
      g.bezierCurveTo(cx+78, y0+222, cx+76, y0+188, cx+92, y0+166);
      // waist → right shoulder
      g.bezierCurveTo(cx+126, y0+132, cx+128, y0+60, cx+92, y0+44);
      // shoulder line back to start
      g.bezierCurveTo(cx+60, y0+18, cx-60, y0+18, cx-92, y0+44);
      g.closePath();
      g.fill();
      g.stroke();

      // center “spine” highlight
      g.strokeStyle = 'rgba(255,255,255,0.08)';
      g.lineWidth = 4;
      g.beginPath();
      g.moveTo(cx, y0+48);
      g.bezierCurveTo(cx-6, y0+120, cx+6, y0+190, cx, y0+292);
      g.stroke();
    }

    // arms (rounded thick strokes with a slight bend)
    {
      g.strokeStyle = 'rgba(255,255,255,0.12)';
      g.lineWidth = 26;
      g.lineCap = 'round';
      g.lineJoin = 'round';

      // left arm
      g.beginPath();
      g.moveTo(cx-96, topY+132);
      g.quadraticCurveTo(cx-162, topY+190, cx-150, topY+300);
      g.quadraticCurveTo(cx-144, topY+352, cx-120, topY+388);
      g.stroke();

      // right arm
      g.beginPath();
      g.moveTo(cx+96, topY+132);
      g.quadraticCurveTo(cx+162, topY+190, cx+150, topY+300);
      g.quadraticCurveTo(cx+144, topY+352, cx+120, topY+388);
      g.stroke();

      // arm edge
      g.strokeStyle = outline;
      g.lineWidth = 2;
      g.beginPath();
      g.moveTo(cx-96, topY+132);
      g.quadraticCurveTo(cx-162, topY+190, cx-150, topY+300);
      g.quadraticCurveTo(cx-144, topY+352, cx-120, topY+388);
      g.moveTo(cx+96, topY+132);
      g.quadraticCurveTo(cx+162, topY+190, cx+150, topY+300);
      g.quadraticCurveTo(cx+144, topY+352, cx+120, topY+388);
      g.stroke();
    }

    // hands (small stylized shapes at the end of arms)
    {
      const hand = (x,y)=>{
        const hg = g.createRadialGradient(x-4,y-6, 4, x,y, 18);
        hg.addColorStop(0,'rgba(255,255,255,0.18)');
        hg.addColorStop(1,'rgba(255,255,255,0.06)');
        g.fillStyle = hg;
        g.strokeStyle = outline;
        g.lineWidth = 2;
        g.beginPath();
        g.ellipse(x, y, 16, 12, 0.2, 0, Math.PI*2);
        g.fill();
        g.stroke();
      };
      hand(cx-120, topY+392);
      hand(cx+120, topY+392);
    }

    // legs (tapered, more human than rectangles)
    {
      const hipY = topY + 380;

      function leg(side){
        const s = side; // -1 left, +1 right
        const x0 = cx + s*34;
        g.fillStyle = 'rgba(255,255,255,0.085)';
        g.strokeStyle = outline;
        g.lineWidth = 2;

        g.beginPath();
        g.moveTo(x0 - 34, hipY);
        g.bezierCurveTo(x0 - 46, hipY+90, x0 - 36, hipY+210, x0 - 18, hipY+290);
        g.bezierCurveTo(x0 - 8, hipY+330, x0 + 8, hipY+330, x0 + 18, hipY+290);
        g.bezierCurveTo(x0 + 36, hipY+210, x0 + 46, hipY+90, x0 + 34, hipY);
        g.bezierCurveTo(x0 + 18, hipY-16, x0 - 18, hipY-16, x0 - 34, hipY);
        g.closePath();
        g.fill();
        g.stroke();
      }

      leg(-1);
      leg(+1);

      // tiny “ankle” shine
      g.fillStyle = 'rgba(255,255,255,0.08)';
      roundRect(g, cx-68, hipY+292, 46, 10, 6);
      roundRect(g, cx+22, hipY+292, 46, 10, 6);
      g.fill();

      // feet
      g.fillStyle = 'rgba(0,0,0,0.20)';
      g.strokeStyle = outline;
      g.lineWidth = 2;
      g.beginPath(); g.ellipse(cx-46, hipY+318, 38, 14, 0, 0, Math.PI*2); g.fill(); g.stroke();
      g.beginPath(); g.ellipse(cx+46, hipY+318, 38, 14, 0, 0, Math.PI*2); g.fill(); g.stroke();
    }

    g.restore();
  }

  function drawItemLayer(g, slot, item){
    const cx = 300;
    const topY = 140;

    g.save();

    // subtle glow
    const glow = g.createRadialGradient(cx, topY+260, 30, cx, topY+260, 330);
    glow.addColorStop(0, item.color + '35');
    glow.addColorStop(1, 'rgba(0,0,0,0)');
    g.fillStyle = glow;
    g.beginPath();
    g.arc(cx, topY+260, 330, 0, Math.PI*2);
    g.fill();

    // slot-specific shapes
    g.strokeStyle = 'rgba(255,255,255,0.20)';
    g.lineWidth = 2;

    function fillWith(alpha=0.82){
      g.fillStyle = hexToRgba(item.color, alpha);
    }

    if(slot === 'hair'){
      fillWith(0.86);
      // hair cap
      g.beginPath();
      g.ellipse(cx, topY-20, 70, 44, 0, Math.PI, Math.PI*2);
      g.lineTo(cx+70, topY+8);
      g.ellipse(cx, topY+8, 70, 40, 0, 0, Math.PI);
      g.closePath();
      g.fill();
      g.stroke();
      // bangs
      g.fillStyle = hexToRgba(item.color, 0.62);
      for(let i=-2;i<=2;i++){
        g.beginPath();
        g.ellipse(cx + i*20, topY+18, 12, 26, 0.3*i, 0, Math.PI*2);
        g.fill();
      }
    }

    if(slot === 'top'){
      fillWith(0.78);
      // jacket/top shape
      roundRect(g, cx-90, topY+92, 180, 210, 54);
      g.fill();
      g.stroke();
      // collar stripe
      g.fillStyle = 'rgba(255,255,255,0.14)';
      roundRect(g, cx-60, topY+102, 120, 24, 14);
      g.fill();
      // chest emblem based on tags
      const tset = new Set(item.tags);
      g.save();
      g.translate(cx, topY+190);
      g.fillStyle = 'rgba(0,0,0,0.18)';
      if(tset.has('pixel')){
        for(let y=-18;y<=18;y+=12){
          for(let x=-18;x<=18;x+=12){
            if((x+y)%24===0){
              g.fillRect(x-5,y-5,10,10);
            }
          }
        }
      } else if(tset.has('space')){
        g.beginPath();
        g.moveTo(0,-22);
        g.lineTo(18,18);
        g.lineTo(-22,-2);
        g.lineTo(22,-2);
        g.lineTo(-18,18);
        g.closePath();
        g.fill();
      } else if(tset.has('nature')){
        g.beginPath();
        g.ellipse(-10, 6, 18, 10, -0.6, 0, Math.PI*2);
        g.ellipse(10, 6, 18, 10, 0.6, 0, Math.PI*2);
        g.fill();
      } else {
        g.beginPath();
        g.arc(0,0,20,0,Math.PI*2);
        g.fill();
      }
      g.restore();
    }

    if(slot === 'bottom'){
      fillWith(0.78);
      // hips coverage
      roundRect(g, cx-80, topY+284, 160, 142, 46);
      g.fill();
      g.stroke();
      // belt
      g.fillStyle = 'rgba(255,255,255,0.12)';
      roundRect(g, cx-72, topY+304, 144, 18, 10);
      g.fill();
      // skirt flare if tag sparkle or cute
      const tset = new Set(item.tags);
      if(tset.has('sparkle') || item.name.includes('Skirt')){
        g.fillStyle = hexToRgba(item.color, 0.64);
        g.beginPath();
        g.moveTo(cx-88, topY+360);
        g.lineTo(cx+88, topY+360);
        g.lineTo(cx+110, topY+440);
        g.lineTo(cx-110, topY+440);
        g.closePath();
        g.fill();
        g.stroke();
      }
    }

    if(slot === 'shoes'){
      fillWith(0.86);
      // left shoe
      roundRect(g, cx-78, topY+560, 78, 40, 16);
      // right shoe
      roundRect(g, cx+2, topY+560, 78, 40, 16);
      g.fill();
      g.stroke();
      // sole highlight
      g.fillStyle = 'rgba(255,255,255,0.18)';
      roundRect(g, cx-72, topY+590, 66, 8, 6);
      roundRect(g, cx+8, topY+590, 66, 8, 6);
      g.fill();
    }

    if(slot === 'accessory'){
      const tset = new Set(item.tags);
      fillWith(0.70);
      if(tset.has('neon') || item.name.includes('Visor')){
        // visor band
        roundRect(g, cx-72, topY+8, 144, 38, 16);
        g.fill();
        g.stroke();
        // lens
        g.fillStyle = 'rgba(0,0,0,0.22)';
        roundRect(g, cx-56, topY+16, 112, 22, 12);
        g.fill();
      } else if(tset.has('warm') || item.name.includes('Scarf')){
        // scarf
        g.fillStyle = hexToRgba(item.color, 0.68);
        roundRect(g, cx-70, topY+110, 140, 38, 18);
        g.fill();
        g.stroke();
        roundRect(g, cx-14, topY+132, 28, 92, 14);
        g.fillStyle = hexToRgba(item.color, 0.56);
        g.fill();
        g.stroke();
      } else if(tset.has('nature')){
        // leaf pin
        g.fillStyle = hexToRgba(item.color, 0.74);
        g.beginPath();
        g.ellipse(cx+76, topY+190, 22, 14, -0.5, 0, Math.PI*2);
        g.fill();
        g.stroke();
        g.beginPath();
        g.moveTo(cx+64, topY+192);
        g.lineTo(cx+90, topY+176);
        g.strokeStyle = 'rgba(0,0,0,0.25)';
        g.lineWidth = 2;
        g.stroke();
      } else if(tset.has('pixel') || item.name.includes('Pet')){
        // pixel pet block
        g.fillStyle = hexToRgba(item.color, 0.78);
        roundRect(g, cx+74, topY+232, 78, 78, 18);
        g.fill();
        g.stroke();
        g.fillStyle = 'rgba(0,0,0,0.20)';
        g.fillRect(cx+92, topY+255, 10, 10);
        g.fillRect(cx+128, topY+255, 10, 10);
        g.fillRect(cx+110, topY+286, 10, 12);
      } else {
        // badge
        g.fillStyle = hexToRgba(item.color, 0.72);
        g.beginPath();
        g.arc(cx+78, topY+200, 26, 0, Math.PI*2);
        g.fill();
        g.stroke();
        g.fillStyle = 'rgba(255,255,255,0.22)';
        g.beginPath();
        g.arc(cx+70, topY+192, 8, 0, Math.PI*2);
        g.fill();
      }
    }

    g.restore();
  }

  function hexToRgba(hex, a){
    // hex like #RRGGBB
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  function drawBriefPanel(g, W, H){
    const x = 520, y = 76;
    const w = W-580, h = 270;

    g.save();
    roundRect(g, x, y, w, h, 18);
    g.fillStyle = 'rgba(0,0,0,0.22)';
    g.fill();
    g.strokeStyle = 'rgba(255,255,255,0.12)';
    g.lineWidth = 2;
    g.stroke();

    g.fillStyle = 'rgba(234,241,255,0.92)';
    g.font = '700 16px ui-sans-serif, system-ui';
    g.fillText('Lookbook', x+16, y+28);

    g.fillStyle = 'rgba(234,241,255,0.75)';
    g.font = '12px ui-sans-serif, system-ui';
    g.fillText('Match the brief tags.', x+16, y+48);

    if(STATE.brief){
      g.fillStyle = 'rgba(234,241,255,0.92)';
      g.font = '800 15px ui-sans-serif, system-ui';
      g.fillText(STATE.brief.name, x+16, y+76);

      g.fillStyle = 'rgba(234,241,255,0.74)';
      g.font = '12px ui-sans-serif, system-ui';
      wrapText(g, STATE.brief.text, x+16, y+96, w-32, 14);

      const have = new Set(outfitTags());
      const chips = STATE.brief.tags;
      let cx = x+16, cy = y+148;
      g.font = '700 12px ui-sans-serif, system-ui';
      for(const tag of chips){
        const good = have.has(tag);
        const padX = 10;
        const tw = g.measureText(tag).width;
        const cw = tw + padX*2;
        if(cx + cw > x + w - 16){
          cx = x+16;
          cy += 34;
        }
        roundRect(g, cx, cy, cw, 24, 999);
        g.fillStyle = good ? 'rgba(124,255,178,0.16)' : 'rgba(255,107,139,0.16)';
        g.fill();
        g.strokeStyle = good ? 'rgba(124,255,178,0.35)' : 'rgba(255,107,139,0.35)';
        g.lineWidth = 1.5;
        g.stroke();
        g.fillStyle = good ? 'rgba(234,241,255,0.92)' : 'rgba(234,241,255,0.86)';
        g.fillText(tag, cx+padX, cy+16);
        cx += cw + 8;
      }

      // little verdict hint
      const req = STATE.brief.tags;
      const missing = req.filter(t => !have.has(t));
      const ok = missing.length < 2;
      g.fillStyle = ok ? 'rgba(124,255,178,0.85)' : 'rgba(255,107,139,0.85)';
      g.font = '800 12px ui-sans-serif, system-ui';
      const hint = ok ? 'Looks viable!' : 'Risky: missing 2+ tags.';
      g.fillText(hint, x+16, y+h-18);
    }

    g.restore();
  }

  function wrapText(g, text, x, y, maxW, lineH){
    const words = text.split(/\s+/);
    let line = '';
    let yy = y;
    for(const w of words){
      const test = line ? (line + ' ' + w) : w;
      if(g.measureText(test).width > maxW && line){
        g.fillText(line, x, yy);
        yy += lineH;
        line = w;
      } else {
        line = test;
      }
    }
    if(line) g.fillText(line, x, yy);
  }

  function drawParticles(g){
    const now = performance.now() / 1000;
    // dt handled in step; here just render
    for(const p of STATE.pops){
      const a = 1 - (p.t / p.life);
      g.fillStyle = hexToRgba(p.col, clamp(a,0,1)*0.65);
      g.beginPath();
      g.arc(p.x, p.y, 3 + a*3, 0, Math.PI*2);
      g.fill();
    }
  }

  function draw(){
    const W = els.c.width;
    const H = els.c.height;

    drawBackdrop(ctx2d, W, H);

    // avatar
    drawMannequin(ctx2d, W, H);

    // layers (order matters)
    drawItemLayer(ctx2d, 'hair', ITEMS.hair[STATE.sel.hair]);
    drawItemLayer(ctx2d, 'top', ITEMS.top[STATE.sel.top]);
    drawItemLayer(ctx2d, 'bottom', ITEMS.bottom[STATE.sel.bottom]);
    drawItemLayer(ctx2d, 'shoes', ITEMS.shoes[STATE.sel.shoes]);
    drawItemLayer(ctx2d, 'accessory', ITEMS.accessory[STATE.sel.accessory]);

    // right-side panel
    drawBriefPanel(ctx2d, W, H);

    // particles
    drawParticles(ctx2d);

    // top label
    ctx2d.save();
    ctx2d.fillStyle = 'rgba(234,241,255,0.86)';
    ctx2d.font = '800 13px ui-sans-serif, system-ui';
    ctx2d.fillText('Wardrobe Wizard', 52, 60);
    ctx2d.fillStyle = 'rgba(234,241,255,0.55)';
    ctx2d.font = '12px ui-sans-serif, system-ui';
    ctx2d.fillText(STATE.practice ? 'Practice' : `Round ${STATE.round}/${STATE.roundsTotal}`, 52, 78);
    ctx2d.restore();
  }

  // -------------------------
  // Loop
  // -------------------------
  let last = performance.now();
  function step(){
    const now = performance.now();
    const dt = Math.min(0.04, (now - last) / 1000);
    last = now;

    // timer
    if(STATE.running && !STATE.practice){
      STATE.t -= dt;
      if(STATE.t < 0) STATE.t = 0;

      // last 5 seconds tick
      if(STATE.t <= 5.0){
        const bucket = Math.floor(STATE.t * 10);
        if(bucket !== STATE.lastTickBeep){
          STATE.lastTickBeep = bucket;
          if(bucket % 10 === 0){
            AudioSys.chord('tick');
          }
        }
      }

      if(STATE.t <= 0){
        endRun({win:false, reason:"Time ran out"});
      }

      refreshHud();
    }

    // particles
    for(const p of STATE.pops){
      p.t += dt;
      p.x += p.vx;
      p.y += p.vy;
      p.vx *= 0.95;
      p.vy *= 0.95;
    }
    STATE.pops = STATE.pops.filter(p => p.t < p.life);

    draw();
    requestAnimationFrame(step);
  }

  // -------------------------
  // Input wiring
  // -------------------------
  document.querySelectorAll('.row button').forEach(btn => {
    btn.addEventListener('click', () => {
      const row = btn.closest('.row');
      const slot = row.getAttribute('data-slot');
      const act = btn.getAttribute('data-action');
      cycle(slot, act === 'next' ? +1 : -1);
    });
  });

  document.addEventListener('keydown', (e) => {
    if(els.overlay.classList.contains('show')){
      // Let Enter start when overlay is open
      if(e.key === 'Enter'){
        e.preventDefault();
        els.startBtn.click();
      }
      return;
    }

    // Cycle currently focused slot if possible
    // Default: A/D cycles Top, W/S cycles Hair for quick play.
    const k = e.key.toLowerCase();
    if(k === 'a'){ cycle('top', -1); }
    else if(k === 'd'){ cycle('top', +1); }
    else if(k === 'w'){ cycle('hair', -1); }
    else if(k === 's'){ cycle('hair', +1); }
    else if(k === 'q'){ cycle('bottom', -1); }
    else if(k === 'e'){ cycle('bottom', +1); }
    else if(k === 'z'){ cycle('shoes', -1); }
    else if(k === 'c'){ cycle('shoes', +1); }
    else if(k === 'x'){ cycle('accessory', +1); }
    else if(k === ' '){
      e.preventDefault();
      submitOutfit();
    }
  });

  els.submitBtn.addEventListener('click', submitOutfit);
  els.shuffleBtn.addEventListener('click', shuffleOutfit);

  els.restartBtn.addEventListener('click', () => {
    // reset overlay instructions view
    document.getElementById('modalTitle').textContent = 'Wardrobe Wizard';
    els.startBtn.textContent = 'Start';
    els.practiceBtn.textContent = 'Practice Round';
    els.overlay.classList.add('show');
    STATE.running = false;
    STATE.practice = false;
    STATE.round = 0;
    STATE.score = 0;
    STATE.brief = null;
    STATE.t = STATE.tMax;
    // Clear goal preview
    if(els.goalCanvas){
      const g = els.goalCanvas.getContext('2d');
      g.clearRect(0,0,els.goalCanvas.width, els.goalCanvas.height);
    }
    setLog('');
    refreshSlotDescs();
    refreshHud();
    AudioSys.tone(300, 0.09, 'triangle', 0.05);
  });

  els.startBtn.addEventListener('click', () => startRun({practice:false}));
  els.practiceBtn.addEventListener('click', () => startRun({practice:true}));

  els.muteBtn.addEventListener('click', () => {
    AudioSys.setEnabled(!AudioSys.isEnabled());
    const on = AudioSys.isEnabled();
    els.muteBtn.textContent = `Sound: ${on ? 'On' : 'Off'}`;
    els.muteBtn.setAttribute('aria-pressed', String(!on));
    if(on) AudioSys.chord('start');
  });

  // initial state
  refreshSlotDescs();
  refreshHud();
  setLog(`<b>Ready.</b> Click <b>Start</b>.`);
  requestAnimationFrame(step);
})();
</script>
</body>
</html>
